<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Friends Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #0b1020; color: #e8eefc; }
    #app { max-width: 720px; margin: 24px auto; padding: 16px; background: #121830; border: 1px solid #27304f; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }
    h1 { margin: 0 0 12px; font-size: 20px; }
    #status, #error { margin: 6px 0 12px; font-size: 14px; }
    #status.ok { color: #8fdf8f; }
    #status.bad { color: #ff9b9b; }
    #error { color: #ff9b9b; white-space: pre-wrap; }
    #messages { height: 360px; overflow-y: auto; padding: 12px; background: #0f152a; border: 1px solid #27304f; border-radius: 8px; }
    .msg { margin: 8px 0; padding: 8px 10px; background: #1a1f3a; border-radius: 8px; }
    .from { font-weight: 700; color: #9bd0ff; }
    .text { margin-top: 4px; white-space: pre-wrap; word-break: break-word; }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    input[type="text"] { flex: 1; min-width: 0; padding: 10px 12px; border-radius: 8px; border: 1px solid #27304f; background: #0f152a; color: #e8eefc; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: #248a4d; color: white; cursor: pointer; font-weight: 600; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; opacity: .8; }
  </style>
</head>
<body>
  <div id="app">
    <h1>Friends Chat</h1>

    <div id="status">Connecting…</div>
    <div id="error"></div>

    <div class="row">
      <input id="name" type="text" placeholder="Your name" maxlength="24" />
      <button id="saveName" type="button">Save name</button>
    </div>

    <div id="messages" aria-live="polite" aria-busy="true"></div>

    <form id="chatForm" class="row" autocomplete="off">
      <input id="input" type="text" placeholder="Type a message…" maxlength="500" />
      <button id="sendBtn" type="submit">Send</button>
    </form>

    <small class="mono">Tip: keep your JSONBin initialized as <code>[]</code> for best results.</small>
  </div>

  <script>
    // ====== CONFIG: replace these two values ======
    const BIN_ID  = "68b86b85ae596e708fe1653e";     // e.g. 65e123abc456789def
    const API_KEY = "$2a$10$w7kHZII5PZ.x1MhtZTBQm.WFZP1ZkfvsbDscb/WNBo9.0kmDtxgH.";    // your JSONBin Master Key (starts with $2b$)
    // =============================================

    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const errorEl  = $("error");
    const nameEl   = $("name");
    const saveBtn  = $("saveName");
    const msgsEl   = $("messages");
    const formEl   = $("chatForm");
    const inputEl  = $("input");
    const sendBtn  = $("sendBtn");

    // Persist name locally
    nameEl.value = localStorage.getItem("displayName") || "";
    saveBtn.addEventListener("click", () => {
      localStorage.setItem("displayName", nameEl.value.trim());
      setStatus("Name saved ✔", true);
    });

    function setStatus(text, ok) {
      statusEl.textContent = text;
      statusEl.className = ok ? "ok" : "bad";
    }
    function showError(text) {
      errorEl.textContent = text || "";
    }
    function escapeHtml(s) {
      return (s || "").replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function scrollToBottom() {
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    // Accept BOTH shapes: [] OR { messages: [] }
    function extractMessages(record) {
      if (Array.isArray(record)) return record;
      if (record && Array.isArray(record.messages)) return record.messages;
      return [];
    }

    function render(messages) {
      msgsEl.innerHTML = "";
      for (const m of messages) {
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `
          <div class="from">${escapeHtml(m.name || "Anon")}</div>
          <div class="text">${escapeHtml(m.text || "")}</div>
        `;
        msgsEl.appendChild(div);
      }
      scrollToBottom();
    }

    async function fetchLatest() {
      const res = await fetch(API_URL + "/latest", {
        headers: { "X-Master-Key": API_KEY, "X-Bin-Meta": "false" }
      });
      if (!res.ok) {
        const body = await res.text();
        throw new Error(`GET ${res.status} ${res.statusText}\n${body}`);
      }
      return res.json();
    }

    async function putArray(messages) {
      const res = await fetch(API_URL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": API_KEY,
          "X-Bin-Meta": "false"
        },
        // We always persist as a plain array to avoid future shape mismatches
        body: JSON.stringify(messages)
      });
      if (!res.ok) {
        const body = await res.text();
        throw new Error(`PUT ${res.status} ${res.statusText}\n${body}`);
      }
      return res.json();
    }

    async function loadMessages() {
      showError("");
      try {
        const data = await fetchLatest();         // { record: ... }
        const messages = extractMessages(data);   // data is already the record when X-Bin-Meta:false
        render(messages);
        setStatus("Connected ✔", true);
        msgsEl.setAttribute("aria-busy", "false");
      } catch (err) {
        setStatus("Error connecting ❌", false);
        showError(String(err.message || err));
      }
    }

    async function sendMessage(name, text) {
      showError("");
      sendBtn.disabled = true;
      try {
        const current = await fetchLatest();
        const messages = extractMessages(current);
        messages.push({ name, text, ts: Date.now() });
        await putArray(messages);
        await loadMessages();
      } catch (err) {
        showError(String(err.message || err));
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Stop page reload on submit
    formEl.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = (nameEl.value || "Anon").trim();
      const text = (inputEl.value || "").trim();
      if (!text) return;
      inputEl.value = "";
      sendMessage(name, text);
    });

    // Initial load + polling
    loadMessages();
    setInterval(loadMessages, 2000);
  </script>
</body>
</html>
