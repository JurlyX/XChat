<!doctype html>
<html lang="en">
<head> 
  <meta charset="utf-8" />
  <title>JSONBin Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; background:#0b1020; color:#f1f1f1; }
    header { display:flex; gap:.5rem; padding:.75rem 1rem; background:#121830; border-bottom:1px solid #333; }
    header input { flex:1; padding:.5rem; border-radius:6px; border:1px solid #444; background:#0f152a; color:#fff; }
    header button { padding:.5rem .75rem; border-radius:6px; border:none; background:#1a7f46; color:white; cursor:pointer; }
    #messages { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:.5rem; }
    .msg { padding:.5rem .75rem; border-radius:8px; background:#1a1f3a; }
    .from { font-weight:bold; color:#9bd0ff; }
    .text { margin-top:.25rem; white-space:pre-wrap; word-break:break-word; }
    form { display:flex; gap:.5rem; padding:.75rem; border-top:1px solid #333; background:#121830; }
    form input { flex:1; padding:.5rem; border-radius:6px; border:1px solid #444; background:#0f152a; color:#fff; }
    form button { padding:.5rem 1rem; border-radius:6px; border:none; background:#1a7f46; color:white; cursor:pointer; }
    #status { padding:.5rem 1rem; font-size:.9rem; background:#222; border-top:1px solid #444; }
  </style>
</head>
<body>
  <header>
    <input id="name" type="text" placeholder="Your name" maxlength="24">
    <button id="saveName">Save</button>
  </header>

  <main id="messages"></main>

  <form id="chatForm">
    <input id="input" type="text" placeholder="Type a message..." maxlength="500">
    <button type="submit">Send</button>
  </form>

  <div id="status">Connectingâ€¦</div>

  <script>
    const BIN_ID = "68b86b85ae596e708fe1653e";   // ðŸ‘ˆ Replace
    const API_KEY = "$2a$10$WC2uU99nX9leNLYgYO/bGeBvgtwaBTU7WRyGV0zKsBND2QhP58WYu"; // ðŸ‘ˆ Replace

    const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    const nameInput = document.getElementById("name");
    const saveNameBtn = document.getElementById("saveName");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("input");
    const messagesEl = document.getElementById("messages");
    const statusEl = document.getElementById("status");

    nameInput.value = localStorage.getItem("displayName") || "";
    saveNameBtn.addEventListener("click", () => {
      localStorage.setItem("displayName", nameInput.value.trim());
      setStatus("Name saved", true);
    });

    function setStatus(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.style.color = ok ? "#9f9" : "#f88";
    }

    function escapeHtml(s) {
      return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]));
    }

    function renderMessages(messages) {
      messagesEl.innerHTML = "";
      messages.forEach(m => {
        const el = document.createElement("div");
        el.className = "msg";
        el.innerHTML = `<div class="from">${escapeHtml(m.name)}</div><div class="text">${escapeHtml(m.text)}</div>`;
        messagesEl.appendChild(el);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function loadMessages() {
      try {
        const res = await fetch(BASE_URL + "/latest", {
          headers: { "X-Master-Key": API_KEY }
        });
        const json = await res.json();
        renderMessages(json.record.messages || []);
        setStatus("Connected âœ”", true);
      } catch (e) {
        setStatus("Error loading messages");
      }
    }

    async function sendMessage(text) {
      try {
        const res = await fetch(BASE_URL + "/latest", {
          headers: { "X-Master-Key": API_KEY }
        });
        const json = await res.json();
        const messages = json.record.messages || [];
        const name = (nameInput.value || "Anon").trim();
        messages.push({ name, text });
        await fetch(BASE_URL, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": API_KEY
          },
          body: JSON.stringify({ messages })
        });
        loadMessages();
      } catch (e) {
        setStatus("Error sending message");
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      sendMessage(text);
    });

    // Refresh every 2s
    setInterval(loadMessages, 2000);
    loadMessages();
  </script>
</body>
</html>
